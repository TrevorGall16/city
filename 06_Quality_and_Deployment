Quality, Coding Standards & Deployment Rules
1. CI/CD & Deployment (Netlify)
1.1 Branch Strategy
main: Production (Auto-deploy).

dev: Preview deployments.

1.2 Build Pipeline Rules
Type Check: next build must pass TypeScript with zero errors.

Schema Validation: Build must fail if any JSON file in /src/data does not pass Zod validation.

Sitemap: scripts/generate-sitemap.js must run post-build.

1.3 Environment Variables
NEXT_PUBLIC_SUPABASE_URL (Public)

NEXT_PUBLIC_SUPABASE_ANON_KEY (Public)

SUPABASE_SERVICE_ROLE_KEY (Private - Build time only)

NEXT_PUBLIC_SITE_URL (Canonical URL)

2. Coding Standards (Strict)
2.1 Component Architecture
Default: Use Server Components (RSC) by default.

Client Components ("use client"): Use ONLY when:

Managing state (useState, useReducer).

Using event handlers (onClick, onChange).

Using lifecycle hooks (useEffect).

Interacting with browser APIs (navigator.clipboard).

Validation: All external data (JSON, API responses) must be validated with Zod schemas.

2.2 Naming Conventions
Components: PascalCase (e.g., CityCard.tsx).

Hooks: camelCase (e.g., useAnalytics.ts).

Files: kebab-case (e.g., city-card.tsx or page.tsx).

Data Files: kebab-case (e.g., paris.json).

2.3 Folder Structure
The Builder AI must adhere to this tree:

Plaintext

/src
  /app           # Next.js App Router (Pages & Layouts)
  /app/api       # Serverless Functions
  /components    # React Components
  /lib           # Utils, Zod Schemas, Supabase Client
  /data/cities   # Static JSON Content
  /types         # TypeScript Interfaces
  /hooks         # Custom Hooks (useAnalytics, etc.)
2.4 React Best Practices
Loops: No inline functions inside JSX loops.

Async: Use <Suspense> boundaries for async Server Components.

Imports: Use absolute imports (@/components/...) where configured.

3. Mobile-First Design Mandates
3.1 Layout Physics
Container: Content must never exceed 100vw (No horizontal scroll).

Touch Targets: All buttons/links/inputs must be min 44px height/width.

Grids:

Mobile: 1 Column.

Tablet: 2 Columns.

Desktop: 3+ Columns.

3.2 Navigation
Mobile: Bottom Fixed Bar (Search / Cities / Profile).

Desktop: Top Sticky Header.

4. Ad Integration Rules (Technical)
4.1 Script Delivery
Ads are delivered via a static script tag in layout.tsx (or <Head>).

Prohibited: No dynamic import() of heavy ad scripts.

4.2 CLS Prevention (Vital)
Skeleton: Ad components must be server-rendered wrappers with fixed height.

Height Rule: Every ad slot must enforce min-height: 280px (or slot-specific height).

Placeholder: Render a gray box (bg-slate-100) until the ad loads.

Behavior: Never collapse an empty ad slot; keep the whitespace to prevent layout jumps.

5. Analytics Requirements
5.1 Event Tracking Hook
Track events using a single client hook: @/hooks/useAnalytics.ts.

Required Events:

search_performed (Query string)

place_opened (Place Name)

copy_name_local (The "Hook" - Critical Metric)

comment_posted (City/Place)

vote_clicked (Up/Down)

5.2 Page Tracking
Each page view must push a page_view event containing { route, slug }.

6. Error Logging & Boundaries
6.1 Client-Side
Non-Breaking: Use console.warn for UI issues that don't crash the app.

Global: Use window.onerror to capture unhandled exceptions.

6.2 Server-Side
Routes: Wrap all async API routes with try/catch blocks.

Logging: Log errors to console.error (Do not use external logging services for V1).

6.3 Fallbacks
Page Level: If City JSON is missing -> Redirect to /.

Component Level: If Image fails -> Show gray placeholder with Icon.

7. Production Readiness Checklist
Before merging to main, the system must pass:

[ ] Lighthouse Mobile: Score â‰¥ 90.

[ ] TypeScript: Zero errors in build.

[ ] Data Integrity: All JSON files pass Zod validation.

[ ] Sitemap: Generated and contains all City + Place URLs.

[ ] Ads: All slots show placeholders before loading (No Shift).

[ ] Console: Zero errors on mobile view.
